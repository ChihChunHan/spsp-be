import express from "express";

const timetable = {
  toXBT: {
    weekdays: [
      "06:11",
      "06:28",
      "06:44",
      "08:14",
      "08:33",
      "08:51",
      "09:09",
      "09:27",
      "09:45",
      "11:15",
      "11:33",
      "11:51",
      "12:09",
      "12:27",
      "12:45",
      "14:15",
      "14:33",
      "14:51",
      "16:03",
      "16:21",
      "16:39",
      "16:57",
      "17:15",
      "17:33",
      "17:51",
      "18:09",
      "18:27",
      "18:45",
      "20:15",
      "20:33",
      "20:51",
      "22:15",
      "22:32",
      "22:47",
      "23:03",
      "23:18",
      "23:35",
      "23:51",
    ],
    saturday: [
      "06:11",
      "06:27",
      "06:43",
      "06:56",
      "08:09",
      "08:21",
      "08:33",
      "08:45",
      "08:57",
      "09:09",
      "09:28",
      "09:47",
      "11:57",
      "12:14",
      "12:32",
      "12:50",
      "14:02",
      "14:20",
      "14:38",
      "14:56",
      "17:10",
      "17:22",
      "17:35",
      "17:47",
      "18:00",
      "18:13",
      "18:25",
      "18:38",
      "18:51",
      "20:11",
      "20:28",
      "20:45",
      "22:03",
      "22:23",
      "22:43",
      "23:03",
      "23:18",
      "23:35",
      "23:51",
    ],
    sunday_and_holidays: [
      "06:11",
      "06:28",
      "06:44",
      "08:14",
      "08:33",
      "08:51",
      "09:09",
      "09:27",
      "09:45",
      "10:06",
      "10:26",
      "10:44",
      "11:15",
      "11:33",
      "11:51",
      "12:09",
      "12:27",
      "12:45",
      "13:08",
      "13:26",
      "13:44",
      "14:15",
      "14:33",
      "14:51",
      "15:09",
      "15:27",
      "15:45",
      "16:03",
      "16:21",
      "16:39",
      "16:57",
      "17:15",
      "17:33",
      "17:51",
      "18:09",
      "18:27",
      "18:45",
      "19:03",
      "19:21",
      "19:39",
      "19:57",
      "20:15",
      "20:33",
      "20:51",
      "21:09",
      "21:27",
      "21:45",
      "22:03",
      "22:23",
      "22:43",
      "23:03",
      "23:18",
      "23:35",
      "23:51",
    ],
  },
  toQZ: {
    weekdays: [
      "06:03",
      "06:19",
      "06:35",
      "06:49",
      "07:10",
      "07:28",
      "07:46",
      "08:02",
      "08:14",
      "08:26",
      "08:38",
      "08:50",
      "09:02",
      "09:21",
      "09:40",
      "09:57",
      "10:10",
      "10:28",
      "10:46",
      "11:04",
      "11:22",
      "11:40",
      "11:58",
      "12:16",
      "12:34",
      "12:52",
      "13:16",
      "13:34",
      "13:52",
      "14:10",
      "14:28",
      "14:46",
      "15:04",
      "15:22",
      "15:40",
      "16:16",
      "16:34",
      "16:50",
      "17:03",
      "17:15",
      "17:28",
      "17:41",
      "17:53",
      "18:06",
      "18:19",
      "18:31",
      "18:44",
      "18:57",
      "19:10",
      "19:25",
      "19:43",
      "20:04",
      "20:22",
      "20:40",
      "20:58",
      "21:12",
      "21:30",
      "21:48",
      "22:06",
      "22:24",
      "22:39",
      "22:54",
      "23:09",
      "23:26",
      "23:42",
      "23:57",
    ],
    saturday: [
      "06:03",
      "06:19",
      "06:35",
      "06:52",
      "07:02",
      "07:14",
      "07:26",
      "07:38",
      "07:50",
      "08:04",
      "08:22",
      "08:40",
      "09:16",
      "09:34",
      "09:52",
      "10:15",
      "10:34",
      "10:52",
      "11:10",
      "11:28",
      "11:46",
      "12:04",
      "12:22",
      "12:40",
      "12:58",
      "13:10",
      "13:28",
      "13:46",
      "14:04",
      "14:22",
      "14:40",
      "14:58",
      "15:04",
      "15:22",
      "15:40",
      "15:58",
      "16:10",
      "16:28",
      "16:46",
      "17:04",
      "17:22",
      "17:40",
      "17:58",
      "18:16",
      "18:34",
      "18:52",
      "19:10",
      "19:28",
      "19:46",
      "20:01",
      "20:18",
      "20:36",
      "20:54",
      "21:16",
      "21:34",
      "21:53",
      "22:12",
      "22:32",
      "22:51",
      "23:09",
      "23:26",
      "23:42",
      "23:57",
    ],
    sunday_and_holidays: [
      "06:03",
      "06:19",
      "06:35",
      "06:52",
      "07:02",
      "07:14",
      "07:26",
      "07:38",
      "07:50",
      "08:04",
      "08:22",
      "08:40",
      "09:16",
      "09:34",
      "09:52",
      "10:15",
      "10:34",
      "10:52",
      "11:10",
      "11:28",
      "11:46",
      "12:04",
      "12:22",
      "12:40",
      "12:58",
      "13:10",
      "13:28",
      "13:46",
      "14:04",
      "14:22",
      "14:40",
      "14:58",
      "15:04",
      "15:22",
      "15:40",
      "15:58",
      "16:10",
      "16:28",
      "16:46",
      "17:04",
      "17:22",
      "17:40",
      "17:58",
      "18:16",
      "18:34",
      "18:52",
      "19:10",
      "19:28",
      "19:46",
      "20:01",
      "20:18",
      "20:36",
      "20:54",
      "21:16",
      "21:34",
      "21:53",
      "22:12",
      "22:32",
      "22:51",
      "23:09",
      "23:26",
      "23:42",
      "23:57",
    ],
  },
};

const app = express();
app.use(express.json());

app.get("/api/mrt", (req, res) => {
  const { to } = req.query;
  let destKey;
  if (to === "xbt") destKey = "toXBT";
  else if (to === "qz") destKey = "toQZ";
  else {
    res.status(400).json({ error: "Invalid or missing 'to' parameter" });
    return;
  }

  // 決定今天是平日、六、日
  const now = new Date();
  const day = now.getDay();
  let dayKey;
  if (day === 0) dayKey = "sunday_and_holidays";
  else if (day === 6) dayKey = "saturday";
  else dayKey = "weekdays";

  const times = timetable[destKey][dayKey];
  // 取得現在時間（分鐘）
  const nowMinutes = now.getHours() * 60 + now.getMinutes();

  // 找下一班
  let found = null;
  for (const t of times) {
    const [h, m] = t.split(":").map(Number);
    const tMinutes = h * 60 + m;
    if (tMinutes >= nowMinutes) {
      found = { nextArrival: t, inMinutes: tMinutes - nowMinutes };
      break;
    }
  }

  if (!found) {
    res.status(200).json({ message: "No more trains today" });
    return;
  }
  res.status(200).json(found);
});

if (process.env.IS_DEV) {
  app.listen(3000, () => console.log("MRT server is running on port 3000"));
}
export default app;
